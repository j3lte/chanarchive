/*
 ----- chanarchive - version 0.4.0 -----
Last build date : 2014-12-17
Source : https://github.com/j3lte/chanarchive
*/
"use strict";function a(b){if(!(this instanceof a))return new a(b);if(h.call(this),b.chan||this.emit("error",new Error("ChanArchiver not properly configured. Missing options.url")),g.extend(this,b.chan),b.chan.alias||this.emit("error",new Error("Unknown board type")),b.chan.useProxy){var c=b.chan.proxyPort||8088;this.proxyUrl="http://localhost:"+c+"/?url="+b.url}this.url=b.url,this.type=b.chan.alias,this._originalFilenames=!1;var d=b.folder||"./";this.saveFolder=d+b.chan.alias+"/",this._extensions=null,this.queue=[],this.fin=[],this.a=0,this.downloadTimeoutID=null,this.abort=!1,this._concurrentThreads=1,this._watchTimeOut=null,this.board=b.url.split(/\/|\?|&|=|\./g)[b.chan.b],this.thread=b.url.split(/\/|\?|&|=|\./g)[b.chan.t],this.name=this.type+"/"+this.board+"/"+this.thread}var b=require("fs"),c=require("request"),d=require("mkdirp"),e=require("../package").version,f={"User-Agent":"Chanarchive/"+e},g=require("lodash"),h=require("events").EventEmitter,i=require("util");i.inherits(a,h),a.prototype.useOriginalFileNames=function(a){return this._originalFilenames=a,this},a.prototype.setMaxThreads=function(a){return this._concurrentThreads=a,this},a.prototype.setWatch=function(a){return this._watchTimeOut=a||1e4,this},a.prototype.setExtensions=function(a){var b=g.map(a.split("/"),function(a){return a?a=0!==a.indexOf(".")?"."+a:a:void 0});this._extensions=b},a.prototype.download=function(){var a=this.proxyUrl||this.baseUrl+this.board+this.del+this.thread+".json",b={url:a,method:"GET",headers:f};return this.downloadTimeoutID=0,c(b,this.parsePage.bind(this)),this},a.prototype.watchDownload=function(){return this._watchTimeOut&&!this.downloadTimeoutID&&(this.downloadTimeoutID=setTimeout(this.download.bind(this),this._watchTimeOut)),this},a.prototype.parsePage=function(a,c,e){var f=this;if(a||200!==c.statusCode||0!==c.headers["content-type"].indexOf("application/json"))this.emit("error",new Error("Thread not found"));else{var h=f.saveFolder+f.board+"/"+f.thread+"/";d(h,function(a){if(a)this.emit("error",new Error("Error creating the folder"));else{var c=JSON.parse(e);b.writeFile(h+"!index.json",JSON.stringify(c,null,4)),g.forEach(c.posts,function(a){a.filename?f.imagePostHandler.call(f,a):a.multi&&g.each(a.multi,function(a){f.imagePostHandler.call(f,a.file)})}),f.parsed()}})}},a.prototype.parsed=function(){var a=this;if(a.emit("parse"),a.queue.length)for(var b=0;b<a._concurrentThreads;b++)a.handleNext();else a._watchTimeOut?a.watchDownload():a.emit("end")},a.prototype.addFile=function(a,b){var c=this,d={url:a,fileName:b,size:0,completed:0,progress:0};~this.fin.indexOf(d.url)||c.queue.push(d)},a.prototype.handleNext=function(){function a(a){return j.existed=a,a?g():void c(j.url).on("response",d).on("data",e).on("error",f).pipe(b.createWriteStream(k)).on("error",f).on("finish",g)}function d(a){j.size=parseInt(a.headers["content-length"],10),i.emit("file:start",j)}function e(a){j.completed+=a.length,j.size&&(j.progress=j.completed/j.size),i.emit("file:chunk",j,a),i.emit("file:progress",j)}function f(a){i.emit("file:error",a,j),b.unlink(k,function(){}),h()}function g(){i.emit("file:end",j),i.fin.push(j.url),h()}function h(){i.a--,i.queue.length?i.handleNext():i.a||(i._watchTimeOut?i.watchDownload():i.emit("end"))}var i=this;if(!i.abort&&i.queue.length){var j=this.queue.shift(),k=i.saveFolder+i.board+"/"+i.thread+"/"+j.fileName;i.a++,b.exists(k,a)}},a.prototype.stop=function(){this.queue.length=0,this.abort=!0,this._watchTimeOut=null,this.downloadTimeoutID&&(clearTimeout(this.downloadTimeoutID),this.emit("end"))},module.exports=a;